<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>pyBBN v0.1.0: docs/evolution.py</title>
  <link rel="stylesheet" href="./pyccoon.css">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
  </script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div id='container'>
  <a id="top"></a>
  <div id="background"></div>
  <div id="footer">
    <a class="btn" id="project-name" href="./index.html">pyBBN v0.1.0</a>
    <a class="btn" class="source source-1" href="#top">Back to top</a>
    <div id="jump_to" class="btn">
    Contents
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source source-2" href="#section-1"> Universe </a>
          <a class="source source-2" href="#section-8"> Main computing routine </a>
          <a class="source source-2" href="#section-9"> Postmortem debugger </a>
          <a class="source source-3" href="#section-11"> 1. Update particles state </a>
          <a class="source source-3" href="#section-12"> 2. Initialize non-equilibrium interactions </a>
          <a class="source source-3" href="#section-13"> 3. Calculate collision integrals </a>
          <a class="source source-3" href="#section-14"> 4. Control integration step size </a>
          <a class="source source-3" href="#section-15"> 5. Update particles distributions </a>
          <a class="source source-3" href="#section-16"> 6. Calculate temperature equation terms </a>
          <a class="source source-2" href="#section-17"> Temperature equation integrand </a>
      </div>
    </div>
    </div>
    <div class="generation-time">
        Generated at
        <a target="_blank" href="http://ckald.github.io/pyccoon/" title="Pyccoon: side-to-side documentation generator">
            <img id="pyccoon-icon" src="./pyccoon_icon.svg" alt="Pyccoon: side-to-side documentation generator" /></a>
        <code>2014-11-26 01:10:22.275101</code>/
        by a diligent
        <a target="_blank" href="http://ckald.github.io/pyccoon/" title="Pyccoon: side-to-side documentation generator">pyccoon</a>
    </div>
  </div>
  <div class='section'>
    <div class='docs'>
      <h1 id="breadcrumbs">/ <a href="evolution.py.html/../index.html">.</a> / <a href="evolution.py.html">evolution.py</a> </h1>
      <ul id="children"></ul>
    </div>
  </div>
  <div class='clearall'>
  <div class='section'>
    <a id="section-0" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-0'>#</a>
          </div>
          <p>-<em>- coding: utf-8 -</em>-</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">UNITS</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">,</span> <span class="n">GRID</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">integrators</span><span class="p">,</span> <span class="n">parallelization</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">plotting</span> <span class="kn">import</span> <span class="n">Plotting</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-1" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-1'>#</a>
          </div>
          <h2><span class="header" href="universe"> Universe </span><a id="universe" class="header-anchor"></a></h2>
<p>The master object that governs the calculation. </p>
        </div>
        <div class='code'>
          <div class="highlight"><pre><span class="k">class</span> <span class="nc">Universe</span><span class="p">:</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-2" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-2'>#</a>
          </div>
          <p>System state is rendered to the log file each <code>log_freq</code> steps</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="n">log_freq</span> <span class="o">=</span> <span class="mi">1</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-3" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-3'>#</a>
          </div>
          <p>Temperature equation integration method: explicit Euler or two-step Heun's method </p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="n">INTEGRATION_METHOD</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;euler&#39;</span><span class="p">,</span> <span class="s">&#39;heun&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-4" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-4'>#</a>
          </div>
          <p>Controls parallelization of the collision integrals calculations</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="n">PARALLELIZE</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-5" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-5'>#</a>
          </div>
          <p>Set size increasing multiplier</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="n">step_size_multiplier</span> <span class="o">=</span> <span class="mf">1.1</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-6" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-6'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="o">=</span><span class="p">[],</span> <span class="n">interactions</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">logfile</span><span class="o">=</span><span class="s">&#39;logs/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39;.txt&#39;</span><span class="p">,</span>
                 <span class="n">plotting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">adaptive_step_size</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">postmortem_debugger</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-7" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-7'>#</a>
          </div>
          <p><span class="pydoc pydoc-param"><span>param</span> <code>particles</code></span> Set of <code>particle.Particle</code> to model
<span class="pydoc pydoc-param"><span>param</span> <code>interactions</code></span> Set of <code>interaction.Interaction</code> - quantum interactions between particle species
<span class="pydoc pydoc-param"><span>param</span> <code>logfile</code></span> Log file path (current <code>datetime</code> by default)
<span class="pydoc pydoc-param"><span>param</span> <code>adaptive_step_size</code></span> Boolean, whether to control the step size or not
<span class="pydoc pydoc-param"><span>param</span> <code>postmortem_debugger</code></span> Boolean, whether to invoke the <code>pdb</code> debugger at the end of computation</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span> <span class="o">=</span> <span class="n">interactions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graphics</span> <span class="o">=</span> <span class="n">Plotting</span><span class="p">()</span> <span class="k">if</span> <span class="n">plotting</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_step_size</span> <span class="o">=</span> <span class="n">adaptive_step_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postmortem_debugger</span> <span class="o">=</span> <span class="n">postmortem_debugger</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-8" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-8'>#</a>
          </div>
          <h2><span class="header" href="main-computing-routine"> Main computing routine </span><a id="main-computing-routine" class="header-anchor"></a></h2>
<p>Modeling is carried in steps of scale factor, starting from the initial conditions defined by a single parameter: the initial temperature.</p>
<p>Initial temperature (e.g. 10 MeV) corresponds to a point in the history of the Universe long before then BBN. Then most particle species are in the thermodynamical equilibrium.</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">print</span> <span class="s">&quot;dx = {} MeV&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">UNITS</span><span class="o">.</span><span class="n">MeV</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">PARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_energy_density</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;aT&#39;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">aT</span><span class="p">]),</span>
            <span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">T</span><span class="p">]),</span>
            <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">a</span><span class="p">]),</span>
            <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">x</span><span class="p">]),</span>
            <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">t</span><span class="p">]),</span>
            <span class="s">&#39;rho&#39;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">rho</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="k">print</span> <span class="s">&#39;#step</span><span class="se">\t</span><span class="s">Time, s</span><span class="se">\t</span><span class="s">aT, MeV</span><span class="se">\t</span><span class="s">T, MeV</span><span class="se">\t</span><span class="s">scale factor</span><span class="se">\t</span><span class="s">ρ energy density, eV^4</span><span class="se">\t</span><span class="s">H, GeV&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">T_final</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Keyboard interrupt!&quot;</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">particle</span>

        <span class="k">print</span> <span class="s">&quot;Data saved to file {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-9" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-9'>#</a>
          </div>
          <h2><span class="header" href="postmortem-debugger"> Postmortem debugger </span><a id="postmortem-debugger" class="header-anchor"></a></h2>
<p>Invoking <code>pdb</code> debugger after the computation is finished allows to do final adjustments and export the missing data without restarting the whole simulation.</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postmortem_debugger</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ipdb</span>
            <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-10" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-10'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">integrators</span><span class="o">.</span><span class="n">heun_correction</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTEGRATION_METHOD</span> <span class="o">==</span> <span class="s">&#39;heun&#39;</span> \
            <span class="k">else</span> <span class="n">integrators</span><span class="o">.</span><span class="n">euler_correction</span>

        <span class="n">PARAMS</span><span class="o">.</span><span class="n">aT</span> <span class="o">+=</span> <span class="n">integrator</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">aT</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">integrand</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">PARAMS</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">dx</span>

        <span class="n">PARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_energy_density</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-11" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-11'>#</a>
          </div>
          <h3><span class="header" href="1.-update-particles-state"> 1. Update particles state </span><a id="1.-update-particles-state" class="header-anchor"></a></h3>
<p>Update particle species distribution functions, check for regime switching, update precalculated variables like energy density and pressure. </p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-12" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-12'>#</a>
          </div>
          <h3><span class="header" href="2.-initialize-non-equilibrium-interactions"> 2. Initialize non-equilibrium interactions </span><a id="2.-initialize-non-equilibrium-interactions" class="header-anchor"></a></h3>
<p>Non-equilibrium interactions of different particle species are treated by a numerical integration of the Boltzmann equation for distribution functions in the expanding space-time.</p>
<p>Depending on the regime of the particle species involved and cosmological parameters, each <code>Interaction</code> object populates <code>Particle.collision_integrands</code> array with currently active <code>Integral</code> objects.</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">init_interactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">interaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span><span class="p">:</span>
            <span class="n">interaction</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-13" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-13'>#</a>
          </div>
          <h3><span class="header" href="3.-calculate-collision-integrals"> 3. Calculate collision integrals </span><a id="3.-calculate-collision-integrals" class="header-anchor"></a></h3>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">calculate_collisions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">particle</span><span class="o">.</span><span class="n">collision_integrands</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARALLELIZE</span><span class="p">:</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">collision_integral</span> <span class="o">=</span> \
                    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parallelization</span><span class="o">.</span><span class="n">parmap</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">integrate_collisions</span><span class="p">,</span>
                                                       <span class="n">GRID</span><span class="o">.</span><span class="n">TEMPLATE</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">collision_integral</span> <span class="o">=</span> \
                    <span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">integrate_collisions</span><span class="p">,</span>
                                    <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_</span><span class="p">])(</span><span class="n">GRID</span><span class="o">.</span><span class="n">TEMPLATE</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-14" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-14'>#</a>
          </div>
          <h3><span class="header" href="4.-control-integration-step-size"> 4. Control integration step size </span><a id="4.-control-integration-step-size" class="header-anchor"></a></h3>
<p><span class="pydoc pydoc-param"><span>param</span> <code>maximum_change</code></span> Maximal allowed relative difference in the distribution functions value after Boltzmann equation integration. Generally, master equation of the temperature can be solved with arbitrarily large step size without significant loss in accuracy. The main problem is the truncation error of the Boltzmann equation integration.</p>
<p><span class="pydoc pydoc-param"><span>param</span> <code>fallback_change</code></span> In the case when distribution functions change too fast, step size is urgently decreased to compensate this effect. <code>fallback_change</code> smaller than <code>maximum_change</code> enhances the integration stability.</p>
<p><span class="pydoc pydoc-param"><span>param</span> <code>exponent</code></span> If distribution functions change is insignificant, step size can be increased by a factor of <code>exponent</code>.</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">control_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maximum_change</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fallback_change</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_step_size</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">exponent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size_multiplier</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">dx</span>
        <span class="n">multipliers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">particle</span><span class="o">.</span><span class="n">in_equilibrium</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">relative_delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">collision_integral</span> <span class="o">*</span> <span class="n">dx</span>
                                            <span class="o">/</span> <span class="n">particle</span><span class="o">.</span><span class="n">_distribution</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">relative_delta</span> <span class="o">&gt;</span> <span class="n">maximum_change</span><span class="p">:</span>
                <span class="n">multipliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback_change</span> <span class="o">/</span> <span class="n">relative_delta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multipliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span>

        <span class="n">multiplier</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span> <span class="k">if</span> <span class="n">multipliers</span> <span class="k">else</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="n">multiplier</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">PARAMS</span><span class="o">.</span><span class="n">dx</span> <span class="o">*=</span> <span class="n">multiplier</span>
            <span class="k">print</span> <span class="s">&quot;//// Step size changed to dx =&quot;</span><span class="p">,</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">UNITS</span><span class="o">.</span><span class="n">MeV</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-15" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-15'>#</a>
          </div>
          <h3><span class="header" href="5.-update-particles-distributions"> 5. Update particles distributions </span><a id="5.-update-particles-distributions" class="header-anchor"></a></h3>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">update_distribution</span><span class="p">()</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-16" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-16'>#</a>
          </div>
          <h3><span class="header" href="6.-calculate-temperature-equation-terms"> 6. Calculate temperature equation terms </span><a id="6.-calculate-temperature-equation-terms" class="header-anchor"></a></h3>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">calculate_temperature_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">numerator</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="n">numerator</span> <span class="o">+=</span> <span class="n">particle</span><span class="o">.</span><span class="n">numerator</span><span class="p">()</span>
            <span class="n">denominator</span> <span class="o">+=</span> <span class="n">particle</span><span class="o">.</span><span class="n">denominator</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-17" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-17'>#</a>
          </div>
          <h2><span class="header" href="temperature-equation-integrand"> Temperature equation integrand </span><a id="temperature-equation-integrand" class="header-anchor"></a></h2>
<p>Master equation for the temperature looks like</p>
<p>\begin{equation}
       \frac{d (aT)}{dx} = \frac{\sum_i{N_i}}{\sum_i{D_i}}
   \end{equation}</p>
<p>Where $N_i$ and $D_i$ represent contributions from different particle species.</p>
<p>See definitions for different regimes:
     * <a href="particles/RadiationParticle.py.html#master-equation-terms">Radiation</a>
     * <a href="particles/IntermediateParticle.py.html#master-equation-terms">Intermediate</a>
     * <a href="particles/DustParticle.py.html#master-equation-terms">Dust</a>
     * <a href="particles/NonEqParticle.py.html#master-equation-terms">Non-equilibrium</a></p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-18" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-18'>#</a>
          </div>
          <p>from common import PARAMS
old_PARAMS = PARAMS.copy()
old_particles = copy.copy(self.particles)
PARAMS.aT = y
PARAMS.x = t
PARAMS.update(self.total_energy_density())</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">update_particles</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_collisions</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control_step_size</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_distributions</span><span class="p">()</span>

        <span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_temperature_terms</span><span class="p">()</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-19" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-19'>#</a>
          </div>
          <p>PARAMS = old_PARAMS
self.particles = old_particles</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-20" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-20'>#</a>
          </div>
          <p>Save current Universe parameters into the data arrays or output files </p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;aT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">aT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMS</span><span class="o">.</span><span class="n">t</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-21" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-21'>#</a>
          </div>
          <p>Runtime log output </p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-22" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-22'>#</a>
          </div>
          <p>Print parameters every now and then</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">),</span> \
                <span class="s">&#39;</span><span class="se">\t</span><span class="s">t =&#39;</span><span class="p">,</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">UNITS</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> \
                <span class="s">&#39;</span><span class="se">\t</span><span class="s">aT =&#39;</span><span class="p">,</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">aT</span> <span class="o">/</span> <span class="n">UNITS</span><span class="o">.</span><span class="n">MeV</span><span class="p">,</span> \
                <span class="s">&#39;</span><span class="se">\t</span><span class="s">T =&#39;</span><span class="p">,</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">UNITS</span><span class="o">.</span><span class="n">MeV</span><span class="p">,</span> \
                <span class="s">&#39;</span><span class="se">\t</span><span class="s">a =&#39;</span><span class="p">,</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">a</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-23" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-23'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">total_energy_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">energy_density</span><span class="p">()</span> <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>

</pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
</div>
</body>
